# Полное изучение платёжных систем и рекомендация: универсальный модуль vs отдельная интеграция

Документ подготовлен после изучения папки **example-Vpos**, текущего проекта **welcomebaby.am** (2 способа оплаты: Ameriabank, Idram) и документации по банкам/онлайн-кассам. Цель — дать честный ответ: как лучше действовать при подключении банковских систем к нескольким проектам и стоит ли делать универсальный модуль.

---

## 1. Что изучено (проверено дважды)

### 1.1 Папка example-Vpos

- **Ameriabank** — документация vPOS 3.1, интеграционные гайды, разбор плагинов (HK Agency, PlanetStudio).
- **Arca / IDBank** — Merchant Manual 1.55.1.0 (IDBank использует Arca), анализ интеграции IDBank.
- **Idram** — Idram Merchant API (форма POST, 3 URL, серверные callback’и, checksum).
- **Другие материалы** — callback и домены (Ameriabank/Arca, Idram), варианты реализации (IMPLEMENTATION_OPTIONS.md), тестирование.

### 1.2 Текущий проект (welcomebaby.am)

- **Подключено 2 способа оплаты:** Ameriabank (карта, vPOS), Idram (кошелёк/карта).
- **Структура:**
  - `src/lib/payments/ameriabank/` — config, service, types; полный цикл: InitPayment → redirect → GetPaymentDetails в callback.
  - `src/lib/payments/idram/` — config, types, checksum; init возвращает formUrl + formData для POST на Idram.
  - API: `/api/payments/ameriabank/init`, `callback`, `status`; `/api/payments/idram/init`, `callback`.
- **Checkout:** выбор способа оплаты (cash, card, ameriabank, idram); для ameriabank — init → redirect по paymentUrl; для idram — init → отправка формы на banking.idram.am.

### 1.3 Онлайн-кассы и банки (Idram, Telcell, FastShift и т.п.)

- В репозитории есть только **Idram** (документация и код).
- **Telcell, FastShift** и другие аналоги в репозитории не найдены — для них нужна отдельная документация от провайдеров.

---

## 2. Сравнительная таблица по платёжным системам (по 10-балльной шкале)

Критерии: простота интеграции, локальное тестирование, безопасность/надёжность проверки оплаты, кол-во валют, наличие серверных callback’ов, документация в проекте.

| Система              | Тип           | Простота интеграции (1–10) | Локальное тест. (localhost) | Проверка статуса        | Валюты     | Серверные callback’и | Документация в проекте | Примечания |
|----------------------|--------------|----------------------------|-------------------------------|--------------------------|------------|----------------------|-------------------------|------------|
| **Ameriabank** (vPOS)| Банк (карта) | 9                           | ✅ Да (BackURL)               | API GetPaymentDetails    | AMD,USD,EUR,RUB | Нет                   | ✅ Да                   | REST JSON, одна BackURL, опечатка resposneCode |
| **IDBank / Arca**    | Банк (карта) | 8                           | ✅ Да (returnUrl)             | API getOrderStatusExtended| AMD,USD,EUR,RUB | Нет                   | ✅ Да                   | form-data, сумма в минимальных единицах |
| **Idram**            | Онлайн-касса | 6                           | ❌ Нужен ngrok (RESULT_URL)   | 2 POST на RESULT_URL + checksum | Только AMD | Да (2 запроса)        | ✅ Да                   | Форма POST, 3 URL, SECRET_KEY |
| **Telcell**          | Онлайн-касса | ?                           | ?                              | ?                        | ?          | ?                    | ❌ Нет в репо           | Нужна своя документация API |
| **FastShift**        | Онлайн-касса | ?                           | ?                              | ?                        | ?          | ?                    | ❌ Нет в репо           | Нужна своя документация API |
| **Другие банки (Arca)** | Банк (карта) | 8                           | ✅ Да                          | Как Arca                 | AMD,USD,EUR,RUB | Нет                   | ✅ Общая с IDBank       | Те же эндпоинты Arca, другие мерчант-данные |
| **Ещё онлайн-кассы** | Разное       | ?                           | ?                              | ?                        | ?          | ?                    | ❌ Нет в репо           | Каждый провайдер — свой API |

**Кратко по качеству:**

- **Лучше по простоте и локальному тесту:** Ameriabank, IDBank/Arca (нет серверных callback’ов, статус через API).
- **Хуже для локальной разработки:** Idram (нужен публичный RESULT_URL, например ngrok).
- **Telcell, FastShift и др.** — без документации в репо нельзя объективно поставить баллы; после получения API-документации таблицу можно дополнить.

---

## 3. Универсальный модуль vs отдельная интеграция в каждом проекте

### 3.1 Вопрос

Можно ли сделать **один универсальный модуль** (банковская/платёжная система), который подключается к каждому проекту, или **лучше каждый раз писать интеграцию заново**?

### 3.2 Рекомендация: **универсальный модуль — лучше**

При условии, что модуль спроектирован как **набор адаптеров с общим интерфейсом** (как в `example-Vpos/Documentation/Other/IMPLEMENTATION_OPTIONS.md`), а не один «монолитный» класс на все банки.

**Почему универсальный модуль не «хуже по качеству», а лучше:**

1. **Один раз правим баги и безопасность** — проверка callback’ов, checksum, статусы оплаты делаются в одном месте и попадают во все проекты.
2. **Единый контракт** — все провайдеры (Ameriabank, Idram, IDBank, в будущем Telcell/FastShift) реализуют один интерфейс (init, callback, status). В проекте только вызываете фабрику/адаптер по имени.
3. **Быстрое подключение к новому проекту** — подключаете пакет, настраиваете env, добавляете маршруты под callback’и. Не копируете десятки файлов.
4. **Версионирование** — при изменении API банка обновляете версию модуля и при необходимости обновляете её в проектах по одному месту.

**Когда «каждый раз заново» было бы оправдано:**

- Один проект на всю жизнь и только один банк.
- Совершенно разный стек (например, один проект на Next.js, другой на чистом PHP) — тогда логично иметь **отдельный универсальный модуль на каждый стек** (например, пакет для Next.js и отдельно для PHP), а не отказ от модуля вообще.

### 3.3 Как лучше сделать универсальный модуль

- **Интерфейс провайдера** (одинаковый для всех):
  - `initPayment(params: InitParams) => Promise<InitResult>`
  - `handleCallback(request) => Promise<CallbackResult>`
  - при необходимости: `getStatus(paymentId) => Promise<StatusResult>`
- **Отдельный адаптер на каждую систему:** Ameriabank, Idram, Arca/IDBank, в будущем Telcell, FastShift и т.д. Каждый адаптер знает только свой API и маппит его в общий контракт.
- **Конфиг через env** — в каждом проекте свои `AMERIA_*`, `IDRAM_*`, `ARCA_*` и т.д.
- **Стек:** для ваших Next.js-проектов — один общий пакет (или монорепо-пакет) с TypeScript; для PHP-проектов — отдельная библиотека/пакет под PHP (как в example-Vpos плагины).

Итог: **иметь универсальный модуль (по стеку) и подключать его в каждый проект — лучше и по качеству, и по поддержке.** Делать с нуля каждый раз — хуже: дублирование, риск ошибок и разная трактовка одних и тех же API.

---

## 4. Что делать дальше

1. **По системам без документации (Telcell, FastShift и т.д.):**  
   Запросить у провайдеров API (регистрация платежа, callback/return URL, проверка статуса, подпись при необходимости). После этого добавить их в таблицу и реализовать адаптеры в общем модуле.

2. **По универсальному модулю:**  
   Вынести текущие реализации Ameriabank и Idram в общий интерфейс (например, в отдельный пакет `@yourcompany/payments` или папку `packages/payments` в монорепо), добавить адаптер для Arca/IDBank по документации из example-Vpos. Новые проекты подключают этот пакет и только настраивают env и роуты.

3. **По качеству:**  
   В модуле централизованно: проверка подписей (Idram), вызов GetPaymentDetails/ getOrderStatusExtended (не доверять только redirect-параметрам), идемпотентность callback’ов, логирование. Это повысит качество во всех проектах сразу.

---

## 5. Краткий ответ на ваши вопросы

- **Как лучше всего действовать?**  
  Использовать **универсальный модуль с адаптерами** под каждый банк/онлайн-кассу (по одному модулю на стек: Next.js/Node и при необходимости отдельно для PHP).

- **Таблица «что лучше/хуже по 10-балльной системе»**  
  См. раздел 2 выше. По документации из репо: Ameriabank и IDBank/Arca — проще и удобнее для разработки; Idram — сложнее из-за callback’ов и ngrok; Telcell/FastShift — требуют отдельной документации.

- **Универсальный модуль — не хуже ли по качеству, чем каждый раз писать заново?**  
  Нет. При нормальной архитектуре (интерфейс + адаптеры) модуль даёт **лучшее** качество и единообразие. Хуже было бы копировать код по проектам и править его вручную в каждом.

Если нужно, могу предложить конкретную структуру файлов и интерфейсов для такого модуля под ваш репозиторий (например, внутри `welcomebaby.am` или в отдельном пакете).
