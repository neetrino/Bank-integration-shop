# E-HDM (Электронные счета/чеки) — изучение и план реализации

> **Конфиг проекта:** учётные данные и пути к сертификатам хранятся в `.env` (EHDM_*) и в папке `Private/` (файлы .crt, .key и справочный ehdm-config.txt). Папка `Private/` и `.env` в `.gitignore`.

## 1. Что такое E-HDM и как это связано с оплатой

**E-HDM (Электронный ՀԴՄ)** — это **не платёжная система**. Это **фискальная отчётность** перед Налоговой службой Армении (ПЕК / taxservice.am).

- **Платёжная система** (ArCa, Ameria, Idram и т.д.) — принимает деньги от клиента и сообщает вам об успешной оплате.
- **E-HDM** — после того как оплата прошла, вы обязаны зарегистрировать чек (продажу) в налоговой через их API.

**Связь:** логическая, не техническая.  
Цепочка: **Оплата успешна → заказ подтверждён → отправить чек в E-HDM (method: print)**.  
Банк и Tax Service — разные системы; общая точка — ваш бэкенд (момент «заказ оплачен»).

---

## 2. Что нужно реализовать у вас (Next.js)

Только интеграцию с **E-HDM API** (электронные чеки). Оплату через банк вы уже делаете.

Кратко по шагам:

1. **Однократная подготовка (вне кода)**  
   - Подать заявку u6 в ՀՆԷՀ на регистрацию электронного ՀԴՄ.  
   - Получить **CRN** (номер регистрации HDM).  
   - Сгенерировать ключи и CSR, получить клиентский сертификат (`.crt`), установить в keystore (`.jks` или `.crt`+`.key`).  
   - В личном кабинете перевести HDM в статус «Գործող» (активный), при необходимости вызвать API `activate`.

2. **В коде (бэкенд Next.js)**  
   - При **успешном подтверждении заказа** (после оплаты) вызывать API Tax Service **print** — передать состав чека (товары, суммы, налоги).  
   - Хранить **seq** (последовательный номер запроса) и увеличивать его при каждом вызове.  
   - Сохранять ответ (receiptId, QR, fiscal и т.д.) в БД и при необходимости отдавать клиенту (например, ссылку на чек или QR).

3. **Опционально**  
   - Печать копии чека (**printCopy**).  
   - Возврат — **getReturnedReceiptInfo** + **printReturnReceipt**.

---

## 3. API Tax Service (краткая выжимка из документации)

### Базовые данные

| Параметр | Значение |
|----------|----------|
| **Production URL** | `https://ecrm.taxservice.am/taxsystem-rs-vcr` |
| **Test URL** | `https://10.3.14.123:447` |
| **Метод** | Все запросы **POST**, тело **JSON**, кодировка **UTF-8** |
| **Заголовок языка** | `language: hy` \| `en` \| `ru` |
| **Аутентификация** | **Клиентский сертификат** (mutual TLS): сервер принимает только запросы с вашим сертификатом (`.crt` + ключ или `.jks`). |

### Методы API (эндпоинты под базой выше)

| Метод | URL | Назначение |
|-------|-----|------------|
| checkConnection | `/api/v1.0/checkConnection` | Проверка связи с ПЕК (передать `crn`). |
| activate | `/api/v1.0/activate` | Активация E-HDM после одобрения заявки (передать `crn`). |
| configureDepartments | `/api/v1.0/configureDepartments` | Настройка отделов и режимов налогообложения (один раз или при смене режимов). |
| getGoodList | `/api/v1.0/getGoodList` | Получение номенклатуры из налоговой (опционально). |
| **print** | **/api/v1.0/print** | **Печать чека продажи — основной метод для каждой оплаченной продажи.** |
| printCopy | `/api/v1.0/printCopy` | Печать копии чека по `receiptId`. |
| getReturnedReceiptInfo | `/api/v1.0/getReturnedReceiptInfo` | Информация о возвратном чеке. |
| printReturnReceipt | `/api/v1.0/printReturnReceipt` | Печать чека возврата. |

### Общие правила запросов

- В **каждом** запросе обязательно поле **`crn`** (номер регистрации HDM).
- **`seq`** (sequence) — порядковый номер запроса:
  - В первом запросе можно задать любое целое число.
  - В каждом следующем запросе `seq` должен быть **строго больше** предыдущего (как правило, предыдущий + 1).
  - Нужно хранить последний использованный `seq` (например, в БД или env) и увеличивать при каждом вызове.

### Формат ответа (общий)

- Успех: `code: 0`, `message: "OK"`, `result` — строка или объект с данными.
- Ошибка: `code` ≠ 0, `errorMessage` — текст ошибки, `result`: null.

---

## 4. Метод print — что отправлять (на основе доки и плагина virtual-hdm)

Пример тела запроса (режим «товары», mode = 2):

```json
{
  "crn": "52014201",
  "seq": 2,
  "mode": 2,
  "cashierId": 1,
  "cardAmount": 40000,
  "cashAmount": 0,
  "items": [
    {
      "dep": 1,
      "adgCode": "9205",
      "goodCode": "9205-13",
      "goodName": "Наименование товара",
      "quantity": 2,
      "unit": "հատ",
      "price": 25000
    }
  ]
}
```

**Поля уровня чека:**

- **crn** — номер регистрации HDM (из налоговой).
- **seq** — ваш порядковый номер запроса (инкремент при каждом вызове).
- **mode** — 1 (предоплата) или 2 (режим товаров); для интернет-магазина обычно 2.
- **cashierId** — идентификатор кассира (число).
- **cardAmount** / **cashAmount** — сумма оплаты картой / наличными (в минимальных единицах, например драм без копеек; по доке — 2 знака после запятой для денег).
- **items** — массив позиций чека.

**Поля каждой позиции (items[]):**

- **dep** — код отдела/режима налогообложения (1 — с НДС, 2 — без НДС, 3 — оборотный налог, 7 — микро и т.д.; по доке и плагину).
- **adgCode** — код АТГ (классификатор).
- **goodCode** — код товара (например, SKU или код из getGoodList).
- **goodName** — название (например, до 30 символов).
- **quantity** — количество (по доке — до 3 знаков после запятой для весовых и т.п.).
- **unit** — единица измерения (например, «հատ», «кг»).
- **price** — цена за единицу (деньги — 2 знака после запятой).

При необходимости в доке описаны **discount**, **discountType**, **additionalDiscount**, **additionalDiscountType** для скидок.

**Ответ print (успех):** в `result` приходят в т.ч. `receiptId`, `qr`, `crn`, `sn`, `tin`, `taxpayer`, `address`, `time`, `fiscal`, `total` — их нужно сохранить и при необходимости показывать клиенту (например, QR на странице «Заказ оплачен» или в письме).

---

## 5. Что взято из плагинов (для анализа)

### virtual-hdm-for-taxservice-am (WooCommerce)

- **Когда печатают чек:** при смене статуса заказа на `processing` или `completed` (т.е. после успешной оплаты).
- **Как формируют body для print:**  
  - `mode: 2`, `crn`, `seq` (из option `taxServiceSeqNumber` — инкремент при каждом запросе), `cashierId: 1`.  
  - `cardAmount` или `cashAmount` в зависимости от способа оплаты.  
  - Для доставки при необходимости добавляют отдельную позицию (adgCode, goodCode, goodName, quantity, unit, price).  
  - Для каждого товара заказа: dep по типу налога, adgCode (из настроек или мета товара), goodCode (SKU или validationCode), goodName, quantity, unit, price; при скидке — discount, discountType.
- **Вызов API:** HTTPS POST, JSON body, **клиентский сертификат** (CURL: `CURLOPT_SSLCERT`, `CURLOPT_SSLKEY`, `CURLOPT_SSLKEYPASSWD`).
- **После успешного print:** сохраняют в БД результат (receiptId, qr, sn, tin, taxpayer, address, time, fiscal, total), отправляют письмо клиенту с чеком/QR.
- **Возврат:** по `receiptId` из сохранённого чека вызывают `printReturnReceipt` с `returnItemList` (receiptProductId, quantity).

### arca-payment-gateway-pro

- Отвечает за **оплату** (ArCa, Idram, банки). В форме инвойса есть фильтр `eHDM-getReceiptQR`: если подключён E-HDM, подставляют QR чека в инвойс.  
- Подтверждает идею: **оплата и E-HDM разделены**; E-HDM вызывается после оплаты, а в платёжный инвойс только подставляется уже сформированный QR чека.

---

## 6. План реализации в Next.js (пошагово)

1. **Подготовка (вне репозитория)**  
   - Регистрация E-HDM в ՀՆԷՀ, получение CRN и клиентского сертификата.  
   - Сохранение сертификата и ключа в безопасном месте (на сервере; не в репозитории).

2. **Конфиг и секреты**  
   - Добавить в env: URL Tax Service (prod/test), CRN, пути к сертификату и ключу (или keystore), при необходимости passphrase.  
   - Режим теста/продакшена по URL.

3. **Хранение seq**  
   - Таблица или ключ в БД/хранилище для последнего `seq` по данному CRN.  
   - При каждом вызове `print` (и других методов с `seq`) брать следующий номер и сохранять.

4. **Сервис E-HDM в бэкенде**  
   - Модуль (например, `lib/ehdm/` или `lib/tax-service/`):  
     - checkConnection (опционально, для проверки).  
     - print: формирование JSON из заказа (товары, доставка, суммы, card/cash), отправка POST с клиентским сертификатом, разбор ответа.  
     - при ошибке — логирование и повтор/очередь по политике (по доке и требованиям бизнеса).
   - В Node.js для mutual TLS использовать `https` с опциями `cert` и `key` (или эквивалент для .jks, если будете использовать его).

5. **Интеграция в поток заказа**  
   - В месте, где вы фиксируете «заказ оплачен» (webhook от банка или проверка статуса оплаты):  
     - После успешного подтверждения оплаты вызвать `print` с данными заказа.  
     - Сохранить в БД: orderId, receiptId, qr, fiscal, total, дату.  
     - Не блокировать выдачу «Заказ принят» из-за временной ошибки E-HDM — по возможности отложенная повторная отправка.

6. **Клиент и админ**  
   - На странице «Заказ оплачен» / в письме показывать ссылку на чек или QR из ответа print.  
   - При необходимости: печать копии (printCopy) по receiptId из БД.

7. **Возвраты**  
   - При возврате: получить receiptId исходного чека, вызвать getReturnedReceiptInfo при необходимости, затем printReturnReceipt с нужными returnItemList.

8. **Тестирование**  
   - Сначала тестовый стенд (URL 10.3.14.123:447) и тестовый CRN/сертификат, затем переключение на prod.

---

## 7. Итог

- **E-HDM** — это только фискальная регистрация чека в налоговой; с платёжной системой он **не связан по API**, только по бизнес-логике (после оплаты нужно отправить чек).
- Реализовать нужно: **вызов print (и при необходимости activate, configureDepartments, printCopy, printReturnReceipt)** с вашего бэкенда, с **клиентским сертификатом**, с **учётом seq** и сохранением результата (receiptId, QR и т.д.) в БД и отдачей клиенту при необходимости.
- Документация и плагины (virtual-hdm, arca) дают полную картину формата запросов/ответов и момента вызова; перенос этой логики в Next.js API routes + сервисный слой — следующий шаг после утверждения плана.

Если нужно, следующий шаг — детальный план по файлам и API routes (где вызывать print, как хранить seq и чеки в Prisma).

---
*Документация создана и изучена в рамках интеграции электронных счетов (E-HDM) с магазином.*
