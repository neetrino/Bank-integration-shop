# E-HDM: как всё работает и коды товаров (АТГ, goodCode)

## 1. Общий поток: от заказа до чека

```
Клиент оплатил заказ (банк/Idram и т.д.)
        ↓
Ваш бэкенд получает подтверждение оплаты (webhook или проверка статуса)
        ↓
Вызываете API ПЕК: POST /api/v1.0/print
        ↓
Тело запроса: crn, seq, mode=2, cashierId, cardAmount/cashAmount, items[]
        ↓
Каждый item = одна позиция чека: dep, adgCode, goodCode, goodName, quantity, unit, price
        ↓
ПЕК возвращает: receiptId, qr, sn, fiscal, total и т.д.
        ↓
Сохраняете результат в БД, при желании отдаёте клиенту (страница заказа, письмо)
```

**С платёжной системой E-HDM не связан.** Связь только по логике: «оплата прошла → отправить чек».

---

## 2. Разница между adgCode и goodCode (оба обязательны)

| | **adgCode** | **goodCode** |
|---|-------------|--------------|
| **Чьий код** | Код **государственного классификатора** (АТГ). Не ваш — из перечня ПЕК (src.am, Excel 1406-Н / 875-Н). | **Ваш** внутренний код товара: артикул, SKU, id — любая уникальная строка до 50 символов. |
| **Что описывает** | **Тип/категорию** товара для налоговой (например «одежда», «молочные продукты», «услуги доставки»). Один и тот же код у многих товаров. | **Конкретную позицию** в вашем магазине («Товар №123», «SKU-456»). У каждого товара свой goodCode. |
| **Пример** | `"9205"` (из перечня АТГ) | `"clxyz123abc"` (id товара) или `"SKU-001"` (артикул) |
| **Обязателен?** | **Да** | **Да** |

**Кратко:** adgCode = «что это за вид товара» (из списка налоговой), goodCode = «какой именно у вас товар» (ваш идентификатор).

---

## 4. Что такое коды для товаров и зачем они нужны

В каждом **item** (позиции чека) в методе **print** обязательны:

| Поле       | Описание по документации ПЕК |
|-----------|------------------------------|
| **dep**   | Номер отдела/режима налогообложения (1 = с НДС, 2 = без НДС, 3 = оборотный, 7 = микро и т.д.). Один на всю организацию или на группу товаров. |
| **adgCode** | **Код АТГ** (классификатор товаров). Должен быть из официального перечня (сайт src.am → Электронные услуги → Нормы НСКИ-Драмарқлайин меқена). В документации указаны Excel N 1406-Н и N 875-Н с кодами АТГ. |
| **goodCode** | **Код товара** (строка, макс. 50 символов, не пустой). Уникальный идентификатор позиции в вашей системе (артикул, SKU или код из номенклатуры ПЕК). |
| **goodName** | Название товара (макс. 50 символов). |
| **quantity** | Количество (число, до 3 знаков после запятой для весовых). |
| **unit**     | Единица измерения (например «հատ», «кг», «լ»). |
| **price**    | Цена за единицу (деньги, 2 знака после запятой). |

Итого: **для каждой позиции в чеке** нужны как минимум **adgCode** и **goodCode** (плюс название, количество, единица, цена). Без них запрос к API не пройдёт.

---

## 5. Нужно ли указывать свой код для каждого типа товара?

**Да.** Но уровень детализации вы выбираете сами.

### Вариант A: Один общий код на весь магазин (минимум)

- **adgCode** — один и тот же для всех товаров (например код из перечня АТГ, наиболее подходящий по виду деятельности: продукты, одежда, услуги и т.д.).
- **goodCode** — для каждой позиции в заказе можно брать:
  - **SKU товара** (если есть и уникален), или  
  - **id товара**, или  
  - любая уникальная строка (артикул, свой код), макс. 50 символов.
- **unit** — одна общая единица по умолчанию (например «հատ»).

Так можно работать **без** привязки кода АТГ к каждому товару в каталоге: все товары идут с одним adgCode и одной unit, а goodCode формируется из SKU/id.

### Вариант B: Свой код АТГ (и при желании единица) для каждого товара

- В карточке товара храните:
  - **ehdmAdgCode** (или atgCode) — код АТГ из официального перечня для этого типа товара.
  - по желанию **ehdmUnit** (или unitValue) — единица измерения для этого товара («հատ», «кг» и т.д.).
- **goodCode** — по-прежнему SKU, id или свой артикул (уникальный в рамках чека/магазина).

Тогда при формировании чека для каждой позиции подставляете adgCode и unit из карточки товара; если не заданы — подставляете глобальные значения по умолчанию (как в варианте A).

**Итог:**  
Обязательно нужны **adgCode** и **goodCode** в каждой позиции. Либо вы задаёте один общий adgCode (и одну unit) на весь магазин, либо храните adgCode (и unit) по каждому товару — как вам удобнее и как требует учёт.

---

## 6. Откуда брать коды АТГ (adgCode)

- Официальный источник: сайт **https://src.am** → раздел «Электронные услуги» → «Нормы НСКИ-Драмарқлайин меқена» (или аналогичное название) → там указаны Excel-файлы (N 1406-Н, N 875-Н) с перечнем кодов АТГ.
- В плагине **virtual-hdm-for-taxservice-am** этот перечень встроен в код: `admin/service/ATGCodeService.php` — массив кодов вида `"0101" => "Ձիեր, ավանակներ..."`, `"9205" => ...` и т.д. Можно использовать те же коды (они соответствуют официальному классификатору).
- Для доставки в плагине часто используют отдельный код (например 56.21 или из настроек). Доставку можно оформить отдельной позицией в `items` с своим adgCode и goodCode.

**getGoodList** — метод API ПЕК, который возвращает номенклатуру товаров, уже заведённую в налоговой по вашему CRN (после **configureDepartments**). Он **не обязателен** для интернет-магазина: вы можете не вызывать getGoodList и не привязываться к их кодам, а передавать в **goodCode** свои (SKU, id, артикул). Важно только, чтобы **adgCode** был из официального перечня АТГ.

---

## 7. Как это сделано в плагине virtual-hdm (для ориентира)

- **dep** — один на весь чек, из настроек типа налога: `vat` → 1, `without_vat` → 2, `around_tax` → 3, `micro` → 7.
- **adgCode по товару:**  
  - если у товара в мета задан `atgCode` — берётся он;  
  - иначе — глобальная настройка `hkd_tax_service_atg_code`.
- **goodCode по товару:**  
  - если задан `validationCode` — он;  
  - иначе при опции «использовать SKU» — SKU товара;  
  - иначе строка `"no"` (в вашем случае лучше всегда иметь уникальный код, например id или SKU).
- **unit по товару:**  
  - если у товара есть `unitValue` и `atgCode` — берётся unitValue;  
  - иначе — глобальная единица `hkd_tax_service_units_value` (например «Հատ»).
- Доставка — отдельная позиция с настройками: adgCode, goodCode, goodName, unit, quantity 1, price = сумма доставки.

То есть в плагине поддерживаются и «общий код на всех», и «свой АТГ/единица на товар».

---

## 8. Как реализовать у вас (Next.js)

### Уровень чека (один раз на заказ)

- **crn, seq** — из env и БД (seq увеличивать после каждого успешного print).
- **mode** — 2 (режим товаров).
- **cashierId** — фиксированное число (например 1).
- **cardAmount** / **cashAmount** — сумма заказа в зависимости от способа оплаты (в драммах, 2 знака после запятой).
- **dep** — из настроек (тип налога организации): 1, 2, 3 или 7.

### Уровень товаров (каждая позиция заказа)

Для каждого элемента заказа (order item) собрать объект:

- **dep** — как выше (один для всего чека или из настроек по категории/товару).
- **adgCode** — из карточки товара (поле в БД, например `product.ehdmAdgCode`) **или** глобальное значение по умолчанию из env/настроек (один код на весь магазин).
- **goodCode** — уникальный код позиции: **SKU товара** (если есть), иначе **id товара** или артикул. Макс. 50 символов, не пустой.
- **goodName** — название товара (обрезать до 50 символов).
- **quantity** — количество из заказа (число, до 3 знаков после запятой при необходимости).
- **unit** — из карточки товара (поле `product.ehdmUnit`) или глобальное по умолчанию (например «հատ»).
- **price** — цена за единицу (из заказа: сумма по позиции / количество), 2 знака после запятой.

Если в модели **Product** (Prisma) нет полей для E-HDM, можно:

- добавить опциональные поля, например: `ehdmAdgCode String?`, `ehdmUnit String?` (goodCode при этом брать из `id` или отдельного поля `sku`);  
- либо не добавлять поля и использовать только глобальные adgCode и unit из env/настроек, а goodCode = `product.id` или `product.sku`.

### Доставка

Если в заказе есть доставка и вы хотите отразить её в чеке — добавить отдельную позицию в `items` с своим adgCode, goodCode, goodName (например «Доставка»), quantity 1, unit (например «հատ»), price = сумма доставки.

---

## 9. Известны ли коды для нашего проекта (Next.js)?

**Конкретные коды для этого магазина пока не зафиксированы** — известны только правила.

| Код | Для нашего проекта |
|-----|---------------------|
| **adgCode** | **Не выбран.** Нужно взять один код из официального перечня АТГ (src.am или ATGCodeService в плагине) по виду деятельности магазина. Можно задать один общий в `.env` (например `EHDM_DEFAULT_ADG_CODE=9205`) и использовать для всех товаров, либо позже добавить поле в Product. |
| **goodCode** | **Можно брать из данных.** В модели `Product` есть `id` (cuid) — его достаточно как уникальный идентификатор позиции (до 50 символов). Если позже добавите поле артикула/SKU — можно использовать его. |

Итого: **обязательны оба** (adgCode и goodCode в каждой позиции). Для реализации нужно один раз выбрать adgCode по виду деятельности; goodCode уже можно формировать из `product.id`.

---

## 10. Краткие ответы на вопросы

| Вопрос | Ответ |
|--------|--------|
| Нужно ли для каждого типа товара указывать какой-то код? | **Да.** В каждой позиции чека обязательны **adgCode** (из перечня АТГ) и **goodCode** (ваш код товара — SKU, id и т.д.). Можно задать один общий adgCode на весь магазин и не заводить его по каждому товару. |
| Код АТГ — откуда? | Официальный перечень на src.am (Excel 1406-Н, 875-Н) или из кода плагина (ATGCodeService). Один код можно использовать для всех товаров, если вид деятельности один. |
| goodCode — что подставлять? | Любая уникальная строка до 50 символов: SKU, id товара, артикул. Главное — не пустое и не длиннее 50 символов. |
| getGoodList обязателен? | **Нет.** Им можно пользоваться, чтобы взять номенклатуру из ПЕК. Для интернет-магазина достаточно своих goodCode (SKU/id) и корректных adgCode из перечня АТГ. |
| Где хранить adgCode/unit по товару? | Либо в модели Product (ehdmAdgCode, ehdmUnit), либо только в настройках (один adgCode и одна unit на весь магазин). |

Если нужно, следующим шагом можно добавить в Prisma поля `ehdmAdgCode` и `ehdmUnit` для Product и описать точную схему запроса print под ваши заказы.
