# E-HDM: какие файлы нужны для реальной интеграции и что можно взять из WordPress

> **Статус:** данные перенесены: сертификаты в `Private/`, конфиг (CRN, TIN, passphrase, initial seq) — в `.env` и в `Private/ehdm-config.txt`. Оба в `.gitignore`.

## Ситуация

- У клиента уже есть **WordPress** с плагином **virtual-hdm-for-taxservice-am**, E-HDM **уже активен** (работает с реальной налоговой).
- Делаете **новый сайт на Next.js** для того же клиента и хотите подключить там **реальный** (не тестовый) E-HDM.

Ниже — что нужно для реального E-HDM на Next.js и можно ли это взять с WordPress.

---

## 1. Что нужно для реального E-HDM на Next.js

### Обязательно (без этого API не примет запросы)

| Что | Описание | Где взять |
|-----|----------|-----------|
| **Файл сертификата (.crt)** | Клиентский сертификат, выданный ПЕК для вашего E-HDM | С WordPress (см. ниже) или заново из Налоговой |
| **Файл ключа (.key)** | Приватный ключ к этому сертификату | С WordPress (см. ниже) или там же, где хранился при получении .crt |
| **Пароль к ключу (passphrase)** | Если ключ создан с паролем | Из настроек плагина на WordPress |
| **CRN** | Номер регистрации E-HDM в ПЕК (например `52014201`) | Из настроек плагина на WordPress |

### Обязательно для корректной работы (чтобы не ломать нумерацию чеков)

| Что | Описание |
|-----|----------|
| **seq (порядковый номер запроса)** | Целое число, при каждом вызове API должно быть **больше** предыдущего. Лучше хранить в БД и увеличивать на 1 после каждого успешного запроса. | Если **переезжаете с WordPress на Next.js** и используете **тот же CRN** — нужно взять **текущее значение seq** с WordPress и продолжать с него на Next.js (см. ниже). |

### Настройки бизнес-логики (для формирования чека)

Имеет смысл перенести или задать заново в Next.js:

- **Тип налогообложения** (с НДС / без НДС / оборотный / микро и т.д.) — в плагине: `hkd_tax_service_tax_type`
- **Код АТГ по умолчанию** — `hkd_tax_service_atg_code`
- **Единица измерения по умолчанию** — `hkd_tax_service_units_value` (например «Հատ»)
- **Доставка в чеке** (включена/выключена, код, название, единица) — опции `hkd_tax_service_shipping_*`
- **TIN организации** — `hkd_tax_service_tin` (для отображения/отчётов)

Они в плагине хранятся в настройках WordPress (см. ниже), не в файлах.

---

## 2. Где это хранится в WordPress (плагин virtual-hdm-for-taxservice-am)

### Файлы на диске (их нужно скопировать)

Плагин сохраняет загруженные файлы **не в папке плагина**, а в стандартной папке загрузок WordPress:

- Путь: **`wp-content/uploads/tax-service/`**
- Там лежат два файла (имена те, что были при загрузке):
  - файл **.crt** (сертификат);
  - файл **.key** (приватный ключ).

В базе WordPress хранятся **полные пути** к этим файлам (см. ниже), сами файлы — только на диске в `wp-content/uploads/tax-service/`.

### Настройки в базе WordPress (wp_options)

Плагин хранит всё в таблице **`wp_options`**. Ключи (option_name), которые нужны для E-HDM:

| Option name | Что это |
|-------------|--------|
| **hkd_tax_service_upload_file_crt** | Полный путь на сервере к файлу .crt (например `/var/www/html/wp-content/uploads/tax-service/company.crt`) |
| **hkd_tax_service_upload_file_key** | Полный путь на сервере к файлу .key |
| **hkd_tax_service_passphrase** | Пароль к ключу (если задан) |
| **hkd_tax_service_register_number** | **CRN** — номер регистрации E-HDM |
| **taxServiceSeqNumber** | Текущий **seq** (последний использованный порядковый номер запроса) |
| hkd_tax_service_tin | ИНН организации |
| hkd_tax_service_tax_type | Тип налога (vat / without_vat / around_tax / micro) |
| hkd_tax_service_atg_code | Код АТГ по умолчанию |
| hkd_tax_service_units_value | Единица по умолчанию |
| hkd_tax_service_shipping_activated | Включена ли доставка в чеке (1/0) |
| hkd_tax_service_shipping_atg_code | Код АТГ доставки |
| hkd_tax_service_shipping_description | Название доставки |
| hkd_tax_service_shipping_good_code | Код товара «доставка» |
| hkd_tax_service_shipping_unit_value | Единица доставки |

Остальные опции плагина можно посмотреть в коде (префикс `hkd_tax_service_` и `taxServiceSeqNumber`).

---

## 3. Можно ли «вытащить» это из WordPress?

**Да.** Но по-разному для файлов и для настроек.

### Файлы (.crt и .key)

- **Не хранятся в базе** — в базе только пути.
- **Хранятся на диске** в каталоге `wp-content/uploads/tax-service/`.
- **Что сделать:** на сервере WordPress скопировать эту папку (или только два файла .crt и .key) в безопасное место, затем перенести на сервер/окружение Next.js в каталог, откуда приложение будет читать сертификат (например защищённая папка вне репозитория, пути к которой задаются в env).

Не выкладывайте .crt/.key в публичный репозиторий и не держите их в папке с открытым доступом по URL.

### Настройки (CRN, passphrase, seq, TIN, тип налога и т.д.)

- **Хранятся в WordPress** в таблице `wp_options`.
- **Как вытащить:**
  - Через админку WordPress: зайти в настройки плагина «Էլեկտրոնային ՀԴՄ» и переписать CRN, пароль, при необходимости TIN и тип налога.
  - Или из базы: выполнить запрос к `wp_options` по option_name из таблицы выше (например `hkd_tax_service_register_number`, `taxServiceSeqNumber`, `hkd_tax_service_passphrase` и т.д.).
- **seq:** важно взять **текущее** значение `taxServiceSeqNumber` с WordPress, если на Next.js будет использоваться **тот же CRN** и вы продолжаете нумерацию чеков (см. п. 4).

Итого: **файлы** — копируете с диска WordPress; **параметры** — из настроек плагина или из `wp_options`.

---

## 4. Важно: один CRN — одна «очередь» seq

У ПЕК для каждого CRN ведётся одна последовательность запросов (seq). Если один и тот же CRN будет использоваться и на старом WordPress, и на новом Next.js одновременно, два разных приложения начнут слать запросы с разными seq → возможны дубликаты или ошибки.

Практически возможны два варианта:

1. **Полный переход на Next.js:** перестаёте пробивать новые чеки на WordPress, переносите последний **seq** с WordPress в Next.js (из `taxServiceSeqNumber`) и дальше все чеки только с Next.js. Тогда файлы и настройки (CRN, passphrase, при желании TIN, тип налога) можно взять из WordPress один раз, как описано выше.
2. **Два разных сайта с разными E-HDM:** тогда для нового сайта на Next.js нужно оформить в ПЕК **новый** E-HDM (новый CRN и свой сертификат). Старый WordPress продолжает работать со старым CRN, Next.js — с новым. В этом случае с WordPress ничего переносить не нужно для «файлов и CRN», только логику настроек можно повторить.

---

## 5. Краткий чек-лист для реального E-HDM на Next.js

- [ ] Получить с WordPress (или из Налоговой заново):
  - файл **.crt** из `wp-content/uploads/tax-service/`;
  - файл **.key** из той же папки;
  - **CRN** (из настроек плагина или `hkd_tax_service_register_number`);
  - **passphrase** (из настроек или `hkd_tax_service_passphrase`);
  - при переходе с того же CRN — **текущий seq** (`taxServiceSeqNumber`).
- [ ] Положить .crt и .key на сервер Next.js в безопасное место, прописать пути в env (например `EHDM_CERT_PATH`, `EHDM_KEY_PATH`, `EHDM_PASSPHRASE`, `EHDM_CRN`).
- [ ] В коде Next.js хранить и увеличивать **seq** (например в БД) при каждом вызове print/activate/configureDepartments и т.д.
- [ ] Использовать **production URL** налоговой: `https://ecrm.taxservice.am/taxsystem-rs-vcr`.
- [ ] Не коммитить сертификат и ключ в git, не отдавать их на фронт.

Если нужно, могу следующим шагом расписать, куда в вашем Next.js проекте положить env-переменные и как читать .crt/.key в коде (Node.js).
